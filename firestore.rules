rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function per verificare se l'utente è autenticato
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function per verificare se l'utente è il proprietario
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Collection: animals
    // Solo il proprietario può leggere e modificare i propri animali
    match /animals/{animalId} {
      // Permetti lettura solo al proprietario
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      
      // Permetti creazione solo se l'utente è il proprietario
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      
      // Permetti aggiornamento solo al proprietario
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      
      // Permetti eliminazione solo al proprietario
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // Collection: bookings
    // Sistema B2B: gli admin possono creare/gestire tutte le prenotazioni
    // Permette anche creazione pubblica tramite pagina booking.html
    match /bookings/{bookingId} {
      // Permetti lettura a tutti gli autenticati (admin vede tutto)
      allow read: if isAuthenticated();
      
      // Permetti creazione:
      // 1. Utenti autenticati (admin può creare per qualsiasi cliente)
      // 2. Utenti non autenticati ma solo se hanno companyId valido e status pending
      allow create: if isAuthenticated() || 
                    (request.resource.data.companyId != null && 
                     request.resource.data.status == 'pending' &&
                     request.resource.data.source == 'public');
      
      // Permetti aggiornamento solo a utenti autenticati (admin può aggiornare)
      allow update: if isAuthenticated();
      
      // Permetti eliminazione solo a utenti autenticati (admin può eliminare)
      allow delete: if isAuthenticated();
    }
    
    // Collection: users
    // Sistema B2B: gli admin possono creare/gestire clienti
    // Permette anche creazione pubblica tramite pagina booking.html
    match /users/{userId} {
      // Permetti lettura a tutti gli autenticati (admin può vedere clienti)
      allow read: if isAuthenticated();
      
      // Permetti creazione:
      // 1. Utenti autenticati (admin può creare clienti)
      // 2. Utenti non autenticati (per clienti che si registrano tramite pagina pubblica)
      allow create: if isAuthenticated() || true;
      
      // Permetti aggiornamento a tutti gli autenticati (admin può aggiornare clienti)
      // Permette anche aggiornamento pubblico durante creazione prenotazione
      allow update: if isAuthenticated() || 
                    (request.resource.data.email != null && 
                     request.resource.data.displayName != null);
      
      // Permetti eliminazione solo al proprietario o admin (per sicurezza)
      allow delete: if isAuthenticated() && (isOwner(userId) || true);
    }
    
    // Collection: services
    // Gestione servizi - solo utenti autenticati
    match /services/{serviceId} {
        // Permetti lettura solo se l'utente è autenticato e il servizio appartiene all'utente
        allow read: if isAuthenticated() && resource.data.companyId == request.auth.uid;
        
        // Permetti creazione solo se l'utente è autenticato e il companyId corrisponde
        allow create: if isAuthenticated() && request.resource.data.companyId == request.auth.uid;
        
        // Permetti aggiornamento solo se l'utente è autenticato e il servizio appartiene all'utente
        allow update: if isAuthenticated() && resource.data.companyId == request.auth.uid;
        
        // Permetti eliminazione solo se l'utente è autenticato e il servizio appartiene all'utente
        allow delete: if isAuthenticated() && resource.data.companyId == request.auth.uid;
    }

    // Gestione operatori - solo utenti autenticati
    match /operators/{operatorId} {
      allow read, write: if isAuthenticated();
    }
    
    // Collection: companies
    // Profili azienda - solo il proprietario può scrivere
    // Lettura pubblica permessa per mostrare info azienda nella pagina booking
    match /companies/{companyId} {
      // Permetti lettura pubblica (per pagina booking.html)
      allow read: if true;
      
      // Permetti scrittura solo al proprietario
      allow write: if isAuthenticated() && isOwner(companyId);
    }
    
    // Collection: subscriptions
    // Abbonamenti - solo il proprietario
    match /subscriptions/{subscriptionId} {
      allow read, write: if isAuthenticated() && isOwner(subscriptionId);
    }
    
    // Blocca accesso a tutte le altre collection
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

