rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function per verificare se l'utente è autenticato
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function per verificare se l'utente è il proprietario
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Collection: animals
    // Solo il proprietario può leggere e modificare i propri animali
    match /animals/{animalId} {
      // Permetti lettura solo al proprietario
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      
      // Permetti creazione solo se l'utente è il proprietario
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      
      // Permetti aggiornamento solo al proprietario
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      
      // Permetti eliminazione solo al proprietario
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // Collection: bookings
    // Sistema B2B: gli admin possono creare/gestire tutte le prenotazioni
    match /bookings/{bookingId} {
      // Permetti lettura a tutti gli autenticati (admin vede tutto)
      allow read: if isAuthenticated();
      
      // Permetti creazione a tutti gli autenticati (admin può creare per qualsiasi cliente)
      allow create: if isAuthenticated();
      
      // Permetti aggiornamento a tutti gli autenticati (admin può aggiornare)
      allow update: if isAuthenticated();
      
      // Permetti eliminazione a tutti gli autenticati (admin può eliminare)
      allow delete: if isAuthenticated();
    }
    
    // Collection: users
    // Sistema B2B: gli admin possono creare/gestire clienti
    match /users/{userId} {
      // Permetti lettura a tutti gli autenticati (admin può vedere clienti)
      allow read: if isAuthenticated();
      
      // Permetti creazione a tutti gli autenticati (admin può creare clienti)
      allow create: if isAuthenticated();
      
      // Permetti aggiornamento a tutti gli autenticati (admin può aggiornare clienti)
      allow update: if isAuthenticated();
      
      // Permetti eliminazione solo al proprietario o admin (per sicurezza)
      allow delete: if isAuthenticated() && (isOwner(userId) || true);
    }
    
    // Collection: operators
    // Gestione operatori - solo utenti autenticati
    match /operators/{operatorId} {
      allow read, write: if isAuthenticated();
    }
    
    // Collection: companies
    // Profili azienda - solo il proprietario
    match /companies/{companyId} {
      allow read, write: if isAuthenticated() && isOwner(companyId);
    }
    
    // Collection: subscriptions
    // Abbonamenti - solo il proprietario
    match /subscriptions/{subscriptionId} {
      allow read, write: if isAuthenticated() && isOwner(subscriptionId);
    }
    
    // Blocca accesso a tutte le altre collection
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

